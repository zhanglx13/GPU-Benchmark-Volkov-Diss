#! /usr/bin/env bash

## Batch run experiments for all occupancy (1-64) for a single ALPHA
##
## Data used for GTX 1080:
## shared memory per SM:          96 KB
## max shared memory per block:   48 KB
## max number of blocks per SM:   32
## max number of threads per SM:  2048

## $1: ALPHA

declare -A smem
smem=(
    [64]=1536
    [63]=2500
    [60]=2048
    [58]=820
    [57]=1250
    [56]=1700
    [55]=2049
    [54]=2500
    [52]=1800
    [51]=1400
    [50]=2300
    [49]=3073
    [48]=2048
    [45]=2500
    [44]=2049
    [42]=1700
    [40]=2300
    [39]=1800
    [38]=1250
    [36]=2500
    [35]=3073
    [34]=1400
    [33]=2049
    [32]=3072
    [30]=2300
    [29]=820
    [28]=3073
    [27]=2500
    [26]=1800
    [25]=4097
    [24]=4096
    [22]=2049
    [21]=3073
    [20]=4097
    [19]=1250
    [18]=4096
    [17]=1400
    [16]=6144
    [15]=4097
    [14]=3073
    [13]=1800
    [12]=6144
    [11]=2049
    [10]=4097
    [9]=8192
    [8]=6144
    [7]=3073
    [6]=8192
    [5]=4097
    [4]=12288
    [3]=8192
    [2]=12288
)

declare -A bs
bs=(
    [64]=128
    [63]=224
    [60]=160
    [58]=64
    [57]=96
    [56]=128
    [55]=160
    [54]=192
    [52]=128
    [51]=96
    [50]=160
    [49]=224
    [48]=128
    [45]=160
    [44]=128
    [42]=96
    [40]=128
    [39]=96
    [38]=64
    [36]=128
    [35]=160
    [34]=64
    [33]=96
    [32]=128
    [30]=96
    [29]=32
    [28]=128
    [27]=96
    [26]=64
    [25]=160
    [24]=128
    [22]=64
    [21]=96
    [20]=128
    [19]=32
    [18]=96
    [17]=32
    [16]=128
    [15]=96
    [14]=64
    [13]=32
    [12]=96
    [11]=32
    [10]=64
    [9]=96
    [8]=64
    [7]=32
    [6]=64
    [5]=32
    [4]=64
    [3]=32
    [2]=32
)

if [[ $# -eq 0 ]]; then
    echo "Need to specify alpha: ./batch_run.sh <ALPHA>"
    exit 0
fi

echo "ALPHA  maxOcc   arithThr   ITER   BS   SMEM  maxLat   warps" > Pascal_CC61_arithThr_$1.txt
for occ in `seq 64 -1 1`
do
    if [[ ${bs[$occ]} ]]; then
        echo "###########################################"
        printf "##      ALPHA = %3d     maxOcc = %2d      ##\n" $1 $occ
        #echo "## ALPHA=$1 maxOcc=$occ ##"
        echo "###########################################"
        for iter in 32 64 96 128 160 192 224 256 288 320
        do
            echo ""
            echo ">>> ITER = $iter  ALPHA = $1  maxOcc = $occ"
            echo ""
            ./single_run.sh $iter $1 ${bs[$occ]} ${smem[$occ]}
        done
    fi
done
